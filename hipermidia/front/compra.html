<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compras</title>
    <link rel="stylesheet" href="pgcomp/compra.css"> 
</head>
<body>
    <!-- ================= Header ================= -->
    <header class="header">
        <div class="header-left">
            <h1 class="logo">Art Attack</h1>
        </div>

        <div class="header-center">
            <input 
                type="text"
                placeholder="Buscar produtos artesanais..."
                class="search-input"
                oninput="atualizarBusca(this.value)"
            />
        </div>

        <div class="header-right">
            <img 
                src="pgcomp/compra_imgs/heart.png"
                alt="Favoritos"
                class="icon"
            >

            <a href="perfil.html">
                <img
                    src="pgcomp/compra_imgs/user.png"
                    alt="Usu√°rio"
                    class="icon"
                >
            </a>

            <a class="cart-icon-wrapper" id="cartLink" title="Ver carrinho" onclick="abrirCarrinho()">
                <img 
                    src="pgcomp/compra_imgs/cart.png"
                    alt="Carrinho"
                    class="icon"
                    id="headerCartIcon"
                >
                <span class="cart-badge" id="cartCount">0</span>
            </a>

            <!--Esse bot√£o leva ao perfil da loja-->
            <a href="perfil_loja.html" 
                class="btn-loja" 
                id="btnLoja" 
                style="display: none;">
                    <img src="pgcomp/compra_imgs/shop.png" 
                        alt="Loja" 
                        class="icon">
            </a>
            
            <!--Esse bot√£o leva at√© as informa√ß√µes da loja, como produtos vendidos e tals-->
            <a href="venda.html"
                class="btn-login"
                id="btnEspecial"
                style="display: none;">
                    <img 
                        src="https://cdn-icons-png.flaticon.com/512/1828/1828479.png"
                        alt="Painel"
                        class="login-icon"
                    >
                    Dashboard
            </a>

            <a href="compra_publico.html" class="btn-logout" onclick="sairConta()">
                <img 
                    src="pgcomp/compra_imgs/out.png"
                    alt="Sair"
                    class="icon"
                >
                <span>Sair</span>
            </a>
        </div>
    </header>

    <!-- ============== aqui √© onde v√£o estar as tags para filtragem ============== -->
    <nav class="tags-filter">
        <ul class="tag-list" id="filterTags">
        </ul>
    </nav>

    <!-- ============== Os produtos v√£o ficar nessa parte ============== -->
    <main class="main-content">

        <section class="intro">
            <h2>Produtos Artesanais Brasileiros</h2>
            <p>Descubra pe√ßas √∫nicas feitas √† m√£o por artes√£os de todo o Brasil</p>
        </section>

        <!-- ============== Aqui vai ficar a grid dos produtos ============== -->
        <section class="product-grid" id="Grid_prods">

        </section>
    </main>

    <script>
        const prods = [];
        
        let produtoAtual = null // produto atual que pode ser inserido no carrinho
        let filtrosSelecionados = new Set(); // filtros escolhidos
        let textoBusca = ""; //texto de busca

        async function carregarProdutos() {
            try {
                const resposta = await fetch("http://localhost:3000/produtos");
                const lista = await resposta.json();

                prods.push(...lista);

                renderizarFiltros();
                filtrarProdutos();
                verificarUsuario();
            } catch (error) {
                console.error("Erro ao buscar produtos da API:", error);
            }
        }

        // Fun√ß√µes base dos produtos
        function criarCardProduto(produto) {
            return `
                <article class="product-card">
                    <div class="product-image" onclick="openModal(${produto.id})">
                        <img src="${produto.imagem}" alt="${produto.nome}">
                        <button class="favorite-btn">‚ô°</button>
                    </div>

                    <div class="product-info">
                        <h3>${produto.nome}</h3>
                        <span class="producer">por ${produto.produtor}</span>

                        <div class="tags">
                            ${produto.tags.slice(0, 2).map(tag =>
                                `<span class="tag">${tag}</span>`
                            ).join("")}
                            ${produto.tags.length > 2 ? `<span class="tag">+${produto.tags.length - 2}</span>` : ""}
                        </div>

                        <div class="price-stock">
                            <span class="price">R$ ${produto.preco}</span>
                            <span class="stock">${produto.quantidade} dispon√≠veis</span>
                        </div>

                        <button class="btn-cart" onclick="adicionarAoCarrinhoPorId(${produto.id})">Adicionar ao Carrinho</button>
                    </div>
                </article>
            `;
        }

        function carregarProdutos_grid() {
            const grid = document.getElementById("Grid_prods");
            grid.innerHTML = "";

            prods.forEach(prod => {
                grid.innerHTML += criarCardProduto(prod);
            });
        }

        function obterTagsUnicas() {
            const todasTags = prods.flatMap(prod => prod.tags);
            return [...new Set(todasTags)];
        }

        function renderizarFiltros() {
            const container = document.getElementById("filterTags");
            const tags = obterTagsUnicas();

            container.innerHTML = "";

            tags.forEach(tag => {
                const li = document.createElement("li");
                li.className = "filter-tag";
                li.textContent = tag;

                li.onclick = () => ligarFiltro(tag, li);

                container.appendChild(li);
            });
        }

        // Fun√ß√µes de busca e filtragem
        function ligarFiltro(tag, element) {
            if (filtrosSelecionados.has(tag)) {
                filtrosSelecionados.delete(tag);
                element.classList.remove("active");
            } else {
                filtrosSelecionados.add(tag);
                element.classList.add("active");
            }

            filtrarProdutos();
        }

        function filtrarProdutos() {
            const grid = document.getElementById("Grid_prods");
            grid.innerHTML = "";

            const produtosFiltrados = prods.filter(prod => {

                // ===== FILTRO POR TAGS (multi) =====
                const passaTags =
                    filtrosSelecionados.size === 0 ||
                    prod.tags.some(tag => filtrosSelecionados.has(tag));

                // ===== BUSCA SOMENTE PELO NOME =====
                const passaBusca =
                    textoBusca === "" ||
                    prod.nome.toLowerCase().includes(textoBusca);

                return passaTags && passaBusca;
            });

            produtosFiltrados.forEach(prod => {
                grid.innerHTML += criarCardProduto(prod);
            });

            if (produtosFiltrados.length === 0) {
                grid.innerHTML = `
                    <p style="grid-column: 1 / -1; text-align:center;">
                        Nenhum produto encontrado üòï
                    </p>
                `;
            }
        }

        function atualizarBusca(valor) {
            textoBusca = valor.toLowerCase().trim();
            filtrarProdutos();
        }


        // =================== Fun√ß√µes base para a compra no carrinho ===================
        
        // Essa vers√£o √© utilizada no bot√£o do minicard dos produtos
        function adicionarAoCarrinhoPorId(id) {
            const produto = prods.find(p => p.id === id);
            if (!produto) return;

            adicionarAoCarrinho(produto);
        }

        function obterCarrinho() {
            return JSON.parse(localStorage.getItem("carrinho")) || [];
        }

        // Salva o carrinho atual no localstorage
        function salvarCarrinho(carrinho) {
            localStorage.setItem("carrinho", JSON.stringify(carrinho));
        }

        // fun√ß√£o de adicionar no carrinho utilizando um objeto de produto
        // √© utilizado no card do produto em detalhes, e reaproveitado no adicioanrAoCarrinhoPorId
        function adicionarAoCarrinho(produto) {
            const carrinho = obterCarrinho();

            const itemExistente = carrinho.find(item => item.id === produto.id);

            if (itemExistente) {
                itemExistente.qtd += 1;
            } else {
                carrinho.push({
                    id: produto.id,
                    nome: produto.nome,
                    preco: produto.preco,
                    imagem: produto.imagem,
                    qtd: 1
                });
            }

            salvarCarrinho(carrinho);
            atualizarContadorCarrinho();
        }

        function atualizarContadorCarrinho() {
            const carrinho = obterCarrinho();
            const total = carrinho.reduce((acc, item) => acc + item.qtd, 0);
            const contador = document.getElementById("cartCount");

            if (!contador) return;

            if (total > 0) {
                contador.innerText = total;
                contador.style.display = "flex";
            } else {
                contador.style.display = "none";
            }
        }

        function renderizarCarrinho() {
            const carrinho = obterCarrinho();
            const container = document.getElementById("cartItems");
            const totalEl = document.getElementById("cartTotal");

            container.innerHTML = "";
            let total = 0;

            carrinho.forEach(item => {
                total += item.preco * item.qtd;
                console.log(item)
                const div = document.createElement("div");
                div.className = "cart-item";

                div.innerHTML = `
                    <img src="${item.imagem}" class="cart-item-img">

                    <div class="cart-item-info">
                        <h4>${item.nome}</h4>

                        <span class="cart-item-price">
                            R$ ${(item.preco * item.qtd).toFixed(2)}
                        </span>

                        <div class="cart-item-actions">
                            <button class="qty-btn" onclick="alterarQtd(${item.id}, -1)">‚àí</button>
                            <span class="qty">${item.qtd}</span>
                            <button class="qty-btn" onclick="alterarQtd(${item.id}, 1)">+</button>

                            <button class="remove-btn" onclick="removerItem(${item.id})">
                                Remover
                            </button>
                        </div>
                    </div>
                `;


                container.appendChild(div);
            });

            totalEl.innerText = `R$ ${total.toFixed(2)}`;
        }

        function alterarQtd(id, qtd_alt) {
            const carrinho = obterCarrinho();
            const item = carrinho.find(p => p.id === id);

            if (!item) return;

            item.qtd += qtd_alt;

            if (item.qtd <= 0) {
                removerItem(id);
                return;
            }

            salvarCarrinho(carrinho);
            renderizarCarrinho();
            atualizarContadorCarrinho();
        }

        function removerItem(id) {
            let carrinho = obterCarrinho();
            carrinho = carrinho.filter(item => item.id !== id);

            salvarCarrinho(carrinho);
            renderizarCarrinho();
            atualizarContadorCarrinho();
        }

        // =================== Fun√ß√µes para o card de detalhes ===================
        function renderizarTagsModal(tags) {
            const container = document.getElementById("modalTags");
            container.innerHTML = "";

            tags.forEach(tag => {
                const span = document.createElement("span");
                span.classList.add("tag");
                span.textContent = tag;

                container.appendChild(span);
            });
        }

        function openModal(id) {
            const produto = prods.find(p => p.id === id);
            console.log(produto)
            produtoAtual = prods.find(p => p.id === id);
            if (!produtoAtual) return;
            if (!produto) return;

            document.getElementById("modalImage").src = produto.imagem;
            document.getElementById("modalTitle").innerText = produto.nome;
            document.getElementById("modalvendedor").innerText = produto.produtor;
            document.getElementById("modalPrice").innerText = `R$ ${produto.preco}`;
            document.getElementById("modalDescription").innerText = produto.descricao;


            document.getElementById("modalEstoque").innerText = produto.quantidade

            renderizarTagsModal(produto.tags)

            document.getElementById("productModal")
                .classList.add("active");
        }

        function closeModal() {
            document.getElementById("productModal")
                .classList.remove("active");
        }

        // =================== Fun√ß√µes para ver os itens que est√£o no carrinho ===================
        function abrirCarrinho() {
            document.getElementById("cartDrawer").classList.add("open");
            document.getElementById("cartOverlay").classList.add("active");
            renderizarCarrinho();
        }

        function fecharCarrinho() {
            document.getElementById("cartDrawer").classList.remove("open");
            document.getElementById("cartOverlay").classList.remove("active");
        }
        
        // Vai para o fluxo de pagamento, indo pro checkout e depois o pagamento
        function realizarPagamento(){
            window.location.href = "checkout.html"
        }

        // Verifica se o usuario no localstorage √© um vendedor pra mostar o bot√£o de loja
        function verificarUsuario() {
            const usuario = JSON.parse(localStorage.getItem("usuarioLogado"));
            const btnEspecial = document.getElementById("btnEspecial");
            const btnLoja = document.getElementById("btnLoja");

            if (!usuario) return;

            if (usuario.tipo === "vendedor") {
                if (btnEspecial) btnEspecial.style.display = "flex";
                if (btnLoja) btnLoja.style.display = "flex";
            }
        }

        // Desloga e apaga tudo
        function sairConta(){
            localStorage.clear()
            window.location.href = "compra_publico.html"
        }

        carregarProdutos();
        document.getElementById("cartOverlay").addEventListener("click", fecharCarrinho);
        atualizarContadorCarrinho();

    </script>

    <!--========================== O card mais detalhado do produto ==========================-->
    <div class="modal" id="productModal">
        <div class="modal-content">

            <button class="modal-close" onclick="closeModal()">‚úï</button>

            <div class="modal-body">
                <!-- Imagem -->
                <div class="modal-image">
                    <img id="modalImage" src="">
                </div>

                <!-- Informa√ß√µes -->
                <div class="modal-info">
                    <h2 id="modalTitle"></h2>
                    <p class="modal-vendedor">
                        por <span id="modalvendedor"></span>
                    </p>

                    <!-- Aqui tem umas tags de placeholder-->
                    <div class="tags" id="modalTags">
                        <span>Cer√¢mica</span>
                        <span>Decora√ß√£o</span>
                        <span>Cozinha</span>
                    </div>

                    <p class="stock">
                        Disponibilidade: 
                        <strong>
                            <span id="modalEstoque"></span> unidades em estoque
                        </strong>
                    </p>


                    <p class="price" id="modalPrice"></p>

                    <h3>Descri√ß√£o</h3>
                    <p class="description" id="modalDescription"></p>

                    <!-- os bot√µes de intera√ß√£o, s√≥ o bot√£o de compra possui intera√ß√£o-->
                    <div class="modal-actions">
                        <button class="btn-primary" onclick="adicionarAoCarrinho(produtoAtual)">
                            <img class="icon-action-prim" src="pgcomp/compra_imgs/cart.png"></img>
                            <sapn>Adicionar ao Carrinho</sapn>
                        </button>

                        <button class="btn-secondary">
                            <img class="icon-action" src="pgcomp/compra_imgs/heart.png"></img>
                            <span>Favoritar</span>
                        </button>
                        <button class="btn-secondary">
                            <img class="icon-action" src="pgcomp/compra_imgs/share.png"></img>
                            <span>Compartilhar</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

        <!-- Overlay -->
    <div id="cartOverlay" class="cart-overlay"></div>

    <!--========================== Coluna do carrinho ==========================-->
    <aside class="cart-drawer" id="cartDrawer">
        <div class="cart-header">
            <h2>Carrinho de Compras</h2>
            <button onclick="fecharCarrinho()">‚úï</button>
        </div>

        <div id="cartItems" class="cart-items"></div>

        <div class="cart-footer">
            <div class="cart-total">
                <span>Total:</span>
                <strong id="cartTotal">R$ 0,00</strong>
            </div>

            <button class="checkout-btn" onclick="realizarPagamento()">
                Finalizar Compra
            </button>
        </div>
    </aside>

</body>

</html>